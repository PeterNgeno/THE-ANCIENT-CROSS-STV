<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lyrics — THE ANCIENT CROSS STv</title>
  <style>
    :root{--accent:#f2c94c;--bg:#003366;--muted:#d0d7e4}
    body{margin:0;font-family:Inter,system-ui;color:#fff;background:var(--bg)}
    .wrap{max-width:900px;margin:28px auto;padding:18px}
    .card{background:rgba(255,255,255,0.03);padding:18px;border-radius:10px}
    h1{margin:0 0 8px}
    .meta{color:var(--muted);font-size:14px;margin-bottom:8px}
    pre.lyrics{white-space:pre-wrap;background:rgba(0,0,0,0.2);padding:12px;border-radius:8px;color:#fff}
    .small{color:var(--muted);font-size:13px}
    a.btn{display:inline-block;background:var(--accent);color:#003366;padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:700;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="contentCard">
      <h1 id="title">Loading…</h1>
      <div class="meta" id="meta">Please wait while we load the lyric.</div>
      <pre class="lyrics" id="lyricText"> </pre>
      <div id="extra" style="margin-top:12px"></div>
      <div style="margin-top:12px" class="small">Sourced from Google Sheet — THE ANCIENT CROSS STv</div>
    </div>
  </div>

  <script>
    // CONFIG: put your sheet ID here
    const SHEET_ID = '189anRncn21sY8mBEgLpiJQqUQ-X02SEQW_zywHrBugM';
    const SHEET_NAME = 'Sheet1';

    // helper to get ?id= from url
    function getParam(name){
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    // fetch gviz JSON and return parsed rows
    async function fetchSheetJson(){
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
      const res = await fetch(url);
      const text = await res.text();
      // Google returns some padding before JSON; extract the JSON object
      const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}')+1);
      const obj = JSON.parse(jsonText);
      // columns
      const cols = obj.table.cols.map(c => (c.label || '').trim());
      // rows -> array of arrays
      const rows = obj.table.rows.map(r => r.c.map(cell => cell ? cell.v : ''));
      return {cols, rows};
    }

    async function render(){
      const idParam = parseInt(getParam('id') || '1', 10);
      try{
        const sheet = await fetchSheetJson();
        const cols = sheet.cols;
        const rows = sheet.rows;
        if (rows.length === 0){
          document.getElementById('title').textContent = 'No lyrics found in the sheet';
          document.getElementById('lyricText').textContent = '';
          return;
        }
        // idParam is 1-based; rows array is 0-based
        const index = Math.max(0, Math.min(rows.length-1, idParam-1));
        const row = rows[index];
        // Build title: prefer first column if present
        const title = (row[0] && row[0].toString().trim()) || `Lyric #${idParam}`;
        document.getElementById('title').textContent = title;

        // Build content: attempt to find a column named 'Lyrics' or 'Content' or show joined remaining columns
        const colLower = cols.map(c => c.toLowerCase());
        let content = '';
        // Search for 'lyrics' or 'content' column
        const idxLyrics = colLower.indexOf('lyrics') !== -1 ? colLower.indexOf('lyrics') :
                          (colLower.indexOf('content') !== -1 ? colLower.indexOf('content') : -1);
        if (idxLyrics !== -1 && row[idxLyrics]){
          content = row[idxLyrics];
        } else {
          // fallback: join columns 1..end as content
          const parts = [];
          for (let i=1;i<row.length;i++){
            if (row[i]) parts.push((cols[i] ? (cols[i]+': ') : '') + row[i]);
          }
          content = parts.join('\n\n') || 'No content available for this row.';
        }
        document.getElementById('lyricText').textContent = content;

        // meta: show row number and available columns
        document.getElementById('meta').textContent = `Row ${index+1} of ${rows.length} — Columns: ${cols.join(', ')}`;

        // extra: if there's a youtube link column, show a listen button
        const youtubeColIndex = colLower.findIndex(c => c.includes('youtube') || c.includes('link') || c.includes('video'));
        const extraDiv = document.getElementById('extra');
        extraDiv.innerHTML = '';
        if (youtubeColIndex !== -1 && row[youtubeColIndex]){
          const a = document.createElement('a');
          a.href = row[youtubeColIndex];
          a.target = '_blank';
          a.className = 'btn';
          a.textContent = 'Listen on YouTube';
          extraDiv.appendChild(a);
        }
      } catch(err){
        console.error(err);
        document.getElementById('title').textContent = 'Error loading sheet';
        document.getElementById('lyricText').textContent = 'Could not load the Google Sheet. Make sure the sheet is published and visible to anyone with the link.';
      }
    }

    // run
    render();
  </script>
</body>
</html>
